<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Reddit con BinJSON y subida multimedia</title>
<style>
  /* Reset y base */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e9ecef;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; min-height: 100vh;
  }
  header {
    background-color: #343a40;
    color: white;
    padding: 1rem 2rem;
    font-size: 1.5rem;
    font-weight: bold;
    user-select: none;
  }
  main {
    flex: 1;
    max-width: 900px;
    margin: 1rem auto;
    width: 95%;
  }
  #login-section, #new-post-section {
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  #login-section input, #new-post-section input, #new-post-section textarea {
    width: 100%;
    padding: 8px 10px;
    margin: 0.3rem 0 1rem 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
  }
  #login-section button, #new-post-section button {
    cursor: pointer;
    background-color: #007bff;
    color: white;
    font-weight: 600;
    border: none;
    border-radius: 5px;
    padding: 10px 15px;
    transition: background-color 0.3s ease;
  }
  #login-section button:hover, #new-post-section button:hover {
    background-color: #0056b3;
  }
  
  /* Zona de posts con fondo gris claro y scroll si hay overflow */
  #posts {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  /* Cada post/hilo */
  .post {
    background: #ffffffdd; /* blanco semi-transparente */
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 15px;
    box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
  }
  /* Si es respuesta, indentamos y aclaramos un poco */
  .reply {
    background: #f0f0f0dd;
    margin-left: 30px;
  }

  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 8px;
  }
  .post-username {
    font-weight: 700;
    color: #222;
  }
  .post-timestamp {
    font-style: italic;
  }

  .post-content {
    font-size: 1rem;
    margin-bottom: 10px;
    white-space: pre-wrap;
  }

  .post-media img,
  .post-media video {
    max-width: 100%;
    max-height: 300px;
    border-radius: 6px;
    margin-top: 10px;
  }
  .post-media video {
    display: block;
  }

  .btn-delete {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.3s ease;
  }
  .btn-delete:hover {
    background-color: #a71d2a;
  }

  /* Form de respuesta */
  .reply-form {
    margin-top: 10px;
  }
  .reply-form textarea {
    width: 100%;
    min-height: 50px;
    resize: vertical;
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .reply-form button {
    margin-top: 6px;
    background-color: #28a745;
    padding: 7px 15px;
    border-radius: 5px;
    color: white;
    font-weight: 600;
    border: none;
    cursor: pointer;
  }
  .reply-form button:hover {
    background-color: #19692c;
  }

</style>
</head>
<body>
<header>Mini Reddit Demo</header>

<main>

<section id="login-section">
  <label for="username-input"><strong>Nombre de usuario:</strong></label>
  <input type="text" id="username-input" placeholder="Tu nombre de usuario" maxlength="20" />
  <button id="login-btn">Entrar</button>
</section>

<section id="new-post-section" style="display:none;">
  <h3>Nuevo Hilo</h3>
  <input type="text" id="post-title" placeholder="Título (opcional)" maxlength="100" />
  <textarea id="post-text" placeholder="Escribe tu mensaje aquí..." rows="4"></textarea>
  <label for="media-upload">Subir imagen, gif o video (max 10MB):</label>
  <input type="file" id="media-upload" accept="image/*,video/*" />
  <button id="post-btn">Publicar</button>
</section>

<section id="posts">
  <!-- Aquí irán los posts dinámicamente -->
</section>

</main>

<script>
  // --- Datos en memoria ---
  let posts = []; // array de posts y replies
  let username = null;
  const binId = "684bc56e8a456b7966ad4b58";
  const apiKey = "$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu";

  // Helpers para fecha y hora
  function formatDate(timestamp) {
    const d = new Date(timestamp);
    return d.toLocaleString();
  }

  function canDelete(post) {
    if (post.author !== username) return false;
    const now = Date.now();
    return (now - post.timestamp) < 2 * 60 * 60 * 1000; // 2 horas en ms
  }

  // Guardar posts en binjson.io
  async function savePosts() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': apiKey
        },
        body: JSON.stringify(posts)
      });
      if (!res.ok) throw new Error("Error al guardar datos");
    } catch(e) {
      console.error("Error guardando en binjson:", e);
    }
  }

  // Cargar posts de binjson.io
  async function loadPosts() {
    try {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
        headers: {
          'X-Master-Key': apiKey
        }
      });
      if (!res.ok) throw new Error("Error al cargar datos");
      const data = await res.json();
      posts = data.record || [];
      renderPosts();
    } catch(e) {
      console.error("Error cargando de binjson:", e);
    }
  }

  // Renderiza posts y replies en la pantalla
  function renderPosts() {
    const container = document.getElementById('posts');
    container.innerHTML = '';

    // Función recursiva para renderizar post + sus replies
    function renderPost(post, isReply = false) {
      const div = document.createElement('div');
      div.className = 'post' + (isReply ? ' reply' : '');
      div.dataset.id = post.id;

      // Header con usuario y fecha + botón eliminar si puede
      const header = document.createElement('div');
      header.className = 'post-header';

      const userSpan = document.createElement('span');
      userSpan.className = 'post-username';
      userSpan.textContent = post.author;

      const timeSpan = document.createElement('span');
      timeSpan.className = 'post-timestamp';
      timeSpan.textContent = formatDate(post.timestamp);

      header.appendChild(userSpan);
      header.appendChild(timeSpan);

      if(canDelete(post)) {
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete';
        delBtn.textContent = 'Eliminar';
        delBtn.onclick = () => {
          if(confirm('¿Quieres eliminar este mensaje?')) {
            deletePost(post.id);
          }
        };
        header.appendChild(delBtn);
      }

      div.appendChild(header);

      // Contenido
      const content = document.createElement('div');
      content.className = 'post-content';
      content.textContent = post.text;
      div.appendChild(content);

      // Media si hay
      if(post.media) {
        const mediaDiv = document.createElement('div');
        mediaDiv.className = 'post-media';
        if(post.media.type.startsWith('image')) {
          const img = document.createElement('img');
          img.src = post.media.url;
          img.alt = "Imagen subida";
          mediaDiv.appendChild(img);
        } else if(post.media.type.startsWith('video')) {
          const vid = document.createElement('video');
          vid.src = post.media.url;
          vid.controls = true;
          mediaDiv.appendChild(vid);
        }
        div.appendChild(mediaDiv);
      }

      // Si no es reply, mostrar formulario para responder
      if(!isReply) {
        const replyForm = document.createElement('form');
        replyForm.className = 'reply-form';

        const replyTextarea = document.createElement('textarea');
        replyTextarea.placeholder = "Responder...";
        replyTextarea.rows = 2;
        replyTextarea.required = true;
        replyForm.appendChild(replyTextarea);

        const replyBtn = document.createElement('button');
        replyBtn.type = 'submit';
        replyBtn.textContent = 'Responder';
        replyForm.appendChild(replyBtn);

        replyForm.onsubmit = (e) => {
          e.preventDefault();
          const text = replyTextarea.value.trim();
          if(text === '') return alert('Escribe algo para responder');
          addReply(post.id, text);
          replyTextarea.value = '';
        };

        div.appendChild(replyForm);
      }

      container.appendChild(div);

      // Render replies si hay
      if(post.replies && post.replies.length) {
        post.replies.forEach(r => renderPost(r, true));
      }
    }

    posts.forEach(p => renderPost(p));
  }

  // Añadir post nuevo
  async function addPost(title, text, media) {
    const id = 'p' + Date.now() + Math.floor(Math.random()*1000);
    const newPost = {
      id,
      author: username,
      title: title || '',
      text,
      timestamp: Date.now(),
      media: media || null,
      replies: []
    };
    posts.unshift(newPost); // poner al principio
    await savePosts();
    renderPosts();
  }

  // Añadir reply a un post por id
  async function addReply(postId, text) {
    const id = 'r' + Date.now() + Math.floor(Math.random()*1000);
    const reply = {
      id,
      author: username,
      text,
      timestamp: Date.now(),
      media: null
    };
    // Buscar post padre
    function findPostById(arr, id) {
      for(const p of arr) {
        if(p.id === id) return p;
        if(p.replies) {
          const r = findPostById(p.replies, id);
          if(r) return r;
        }
      }
      return null;
    }
    const post = findPostById(posts, postId);
    if(post) {
      if(!post.replies) post.replies = [];
      post.replies.push(reply);
      await savePosts();
      renderPosts();
    }
  }

  // Eliminar post o reply por id (solo propio y <2h)
  async function deletePost(id) {
    function recursiveDelete(arr, id) {
      const index = arr.findIndex(p => p.id === id);
      if(index !== -1) {
        if(canDelete(arr[index])) {
          arr.splice(index,1);
          return true;
        } else {
          alert('No puedes eliminar este mensaje (más de 2 horas o no eres autor)');
          return false;
        }
      }
      for(const p of arr) {
        if(p.replies) {
          if(recursiveDelete(p.replies, id)) return true;
        }
      }
      return false;
    }
    if(recursiveDelete(posts, id)) {
      await savePosts();
      renderPosts();
    }
  }

  // Subir imagen/video a Imgur y devolver URL pública
  async function uploadMedia(file) {
    const clientId = '6d8568e498ff7bc'; // tu Client ID Imgur
    const formData = new FormData();
    formData.append('image', file);

    try {
      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: {
          Authorization: 'Client-ID ' + clientId,
        },
        body: formData
      });
      const data = await res.json();
      if(data.success) {
        return {
          url: data.data.link,
          type: file.type
        };
      } else {
        alert('Error subiendo archivo a Imgur');
        return null;
      }
    } catch(e) {
      alert('Error de conexión al subir archivo');
      return null;
    }
  }

  // Control login y logout
  const loginSection = document.getElementById('login-section');
  const newPostSection = document.getElementById('new-post-section');
  const loginBtn = document.getElementById('login-btn');
  const usernameInput = document.getElementById('username-input');

  loginBtn.onclick = () => {
    const val = usernameInput.value.trim();
    if(val.length < 3) return alert('El nombre de usuario debe tener al menos 3 caracteres');
    username = val;
    loginSection.style.display = 'none';
    newPostSection.style.display = 'block';
    loadPosts();
  };

  // Botón publicar nuevo post
  const postBtn = document.getElementById('post-btn');
  postBtn.onclick = async () => {
    const title = document.getElementById('post-title').value.trim();
    const text = document.getElementById('post-text').value.trim();
    if(text.length === 0) return alert('Escribe algo en el mensaje');
    const mediaFile = document.getElementById('media-upload').files[0];
    let media = null;

    if(mediaFile) {
      if(mediaFile.size > 10*1024*1024) {
        return alert('Archivo demasiado grande (máx 10MB)');
      }
      media = await uploadMedia(mediaFile);
      if(!media) return;
    }
    await addPost(title, text, media);
    document.getElementById('post-title').value = '';
    document.getElementById('post-text').value = '';
    document.getElementById('media-upload').value = '';
  };

</script>
</body>
</html>
