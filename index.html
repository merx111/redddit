<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>MiniReddit Mejorado con eliminación</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&family=Roboto:wght@400;700&display=swap');

    body {
      background: #121212;
      color: #ddd;
      font-family: 'Roboto', sans-serif;
      max-width: 700px;
      margin: 30px auto;
      padding: 0 20px 50px;
      user-select: none;
    }

    h2 {
      text-align: center;
      color: #ff4500;
      margin-bottom: 25px;
      font-weight: 700;
      letter-spacing: 1.5px;
    }

    input, textarea {
      width: 100%;
      background: #222;
      border: 1.5px solid #333;
      border-radius: 8px;
      padding: 10px 15px;
      margin: 8px 0 15px;
      color: #eee;
      font-size: 1rem;
      resize: vertical;
      font-family: 'Roboto Mono', monospace;
      transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #ff4500;
      background: #2c2c2c;
    }

    button {
      background: #ff4500;
      border: none;
      color: white;
      padding: 10px 22px;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    button:hover {
      background: #e03e00;
    }

    #authSection {
      max-width: 360px;
      margin: 0 auto 40px;
      background: #1e1e1e;
      padding: 25px 20px 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px #ff450044;
    }

    #app {
      margin-top: 15px;
    }

    #app p {
      font-size: 1.1rem;
      margin-bottom: 15px;
      font-weight: 500;
    }

    #app p span#currentUser {
      font-weight: 700;
      color: #ff7f50;
    }

    #newPostText {
      min-height: 90px;
    }

    #newPostFile {
      margin-top: -10px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    #posts {
      margin-top: 25px;
    }

    .post {
      background: #222;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(255, 69, 0, 0.3);
      padding: 18px 22px;
      margin-bottom: 25px;
      user-select: text;
      transition: background-color 0.25s ease;
      position: relative;
    }

    .post:hover {
      background: #2d2d2d;
    }

    .post b {
      color: #ff4500;
      font-size: 1.05rem;
      letter-spacing: 0.7px;
    }

    .post .media {
      margin: 12px 0;
      max-width: 100%;
      border-radius: 12px;
      box-shadow: 0 2px 12px #ff450033;
      user-select: none;
    }

    .post video.media {
      max-height: 280px;
    }

    .reply {
      background: #2b2b2b;
      border-radius: 12px;
      margin: 10px 0 10px 20px;
      padding: 10px 16px;
      box-shadow: 0 0 5px #ff450022;
      user-select: text;
      font-size: 0.9rem;
      position: relative;
    }

    .reply b {
      color: #ff7f50;
    }

    .reply:last-child {
      margin-bottom: 5px;
    }

    .reply-input {
      display: flex;
      margin-top: 10px;
      gap: 10px;
      margin-left: 20px;
    }

    .reply-input input {
      flex-grow: 1;
      margin: 0;
    }

    .reply-input button {
      flex-shrink: 0;
      padding: 10px 15px;
      font-size: 0.95rem;
      border-radius: 8px;
    }

    .btn-delete {
      background: #a83232;
      color: white;
      border: none;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 8px;
      cursor: pointer;
      position: absolute;
      right: 12px;
      top: 12px;
      transition: background-color 0.2s ease;
      user-select: none;
      z-index: 1;
    }

    .btn-delete:hover {
      background: #cc3e3e;
    }

    /* Scrollbar para textarea */
    textarea::-webkit-scrollbar {
      width: 8px;
    }
    textarea::-webkit-scrollbar-thumb {
      background: #ff4500cc;
      border-radius: 4px;
    }

  </style>
</head>
<body>
  <h2>MiniReddit Mejorado con eliminación</h2>

  <div id="authSection">
    <input id="username" placeholder="Usuario" autocomplete="off" />
    <input id="password" type="password" placeholder="Contraseña" autocomplete="off" />
    <button onclick="register()">Registrar</button>
    <button onclick="login()">Iniciar Sesión</button>
  </div>

  <div id="app" style="display:none;">
    <p>Bienvenido, <span id="currentUser"></span> <button onclick="logout()">Cerrar sesión</button></p>

    <textarea id="newPostText" placeholder="Escribe un nuevo hilo..."></textarea>
    <input type="file" id="newPostFile" accept="image/*,video/mp4,video/webm,video/ogg" />
    <button onclick="createPost()">Publicar</button>

    <div id="posts"></div>
  </div>

  <script>
    const API_KEY = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
    const BIN_ID = '684bc56e8a456b7966ad4b58';
    const IMGUR_CLIENT_ID = '6d8568e498ff7bc';

    let db = { users: [], posts: [] };
    let currentUser = null;

    // Guarda usuario en localStorage para sesión persistente
    function saveToStorage() {
      localStorage.setItem('redditUser', currentUser);
    }

    // Carga usuario de sesión
    function loadFromStorage() {
      const user = localStorage.getItem('redditUser');
      if (user) {
        currentUser = user;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('currentUser').innerText = currentUser;
      }
    }

    // Obtener DB JSONBin
    async function fetchDB() {
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: { 'X-Master-Key': API_KEY }
        });
        const json = await res.json();
        db = json.record;
        showPosts();
      } catch(e) {
        alert('Error al cargar la base de datos JSONBin.');
      }
    }

    // Actualizar DB JSONBin
    async function updateDB() {
      await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': API_KEY,
          'X-Bin-Versioning': 'false'
        },
        body: JSON.stringify(db)
      });
    }

    // Registro simple
    function register() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      if(!user || !pass) { alert('Rellena usuario y contraseña'); return; }
      if(db.users.find(u => u.user === user)) {
        alert('Usuario ya existe');
        return;
      }
      db.users.push({ user, pass });
      updateDB().then(() => {
        alert('Usuario registrado, ahora inicia sesión');
      });
    }

    // Login simple (sin hash para simplificar)
    function login() {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      const found = db.users.find(u => u.user === user && u.pass === pass);
      if(!found) { alert('Usuario o contraseña incorrectos'); return; }
      currentUser = user;
      saveToStorage();
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('currentUser').innerText = currentUser;
      showPosts();
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('redditUser');
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('app').style.display = 'none';
    }

    // Subir archivo a Imgur y obtener URL
    async function uploadToImgur(file) {
      const form = new FormData();
      form.append('image', file);
      const res = await fetch('https://api.imgur.com/3/image', {
        method: 'POST',
        headers: { Authorization: 'Client-ID ' + IMGUR_CLIENT_ID },
        body: form
      });
      const json = await res.json();
      if(json.success) {
        return json.data.link;
      } else {
        alert('Error subiendo archivo a Imgur');
        return null;
      }
    }

    // Crear elemento media (img o video)
    function createMediaElement(url) {
      const ext = url.split('.').pop().toLowerCase();
      if (['mp4', 'webm', 'ogg'].includes(ext)) {
        const video = document.createElement('video');
        video.src = url;
        video.controls = true;
        video.className = 'media';
        return video;
      } else {
        const img = document.createElement('img');
        img.src = url;
        img.className = 'media';
        return img;
      }
    }

    // Crear post (hilo)
    async function createPost() {
      if(!currentUser) { alert('Inicia sesión primero'); return; }
      const text = document.getElementById('newPostText').value.trim();
      const fileInput = document.getElementById('newPostFile');
      if(!text && fileInput.files.length === 0) {
        alert('Escribe un texto o sube un archivo');
        return;
      }

      let mediaUrl = null;
      if(fileInput.files.length > 0) {
        mediaUrl = await uploadToImgur(fileInput.files[0]);
        if(!mediaUrl) return;
      }

      const newPost = {
        id: 'post_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
        user: currentUser,
        text,
        media: mediaUrl,
        replies: [],
        timestamp: Date.now()
      };

      db.posts.push(newPost);
      await updateDB();
      document.getElementById('newPostText').value = '';
      fileInput.value = '';
      showPosts();
    }

    // Añadir reply a post
    async function addReply(postId, inputId) {
      if(!currentUser) { alert('Inicia sesión primero'); return; }
      const input = document.getElementById(inputId);
      const text = input.value.trim();
      if(!text) return;

      const post = db.posts.find(p => p.id === postId);
      if(!post) return;

      post.replies.push({
        id: 'rep_' + Date.now() + '_' + Math.floor(Math.random() * 1000),
        user: currentUser,
        text,
        timestamp: Date.now()
      });

      await updateDB();
      input.value = '';
      showPosts();
    }

    // Comprobar si un mensaje puede eliminarse (propietario y menos de 2h)
    function canDeleteMessage(messageUser, messageTimestamp) {
      if(currentUser !== messageUser) return false;
      const now = Date.now();
      const diff = now - messageTimestamp;
      return diff < 2 * 60 * 60 * 1000; // 2 horas en ms
    }

    // Eliminar post completo
    async function deletePost(postId) {
      const idx = db.posts.findIndex(p => p.id === postId);
      if(idx === -1) return;
      if(!canDeleteMessage(db.posts[idx].user, db.posts[idx].timestamp)) {
        alert('No puedes eliminar este hilo (solo si eres el autor y menos de 2 horas)');
        return;
      }
      if(!confirm('¿Seguro que quieres eliminar este hilo?')) return;
      db.posts.splice(idx, 1);
      await updateDB();
      showPosts();
    }

    // Eliminar reply dentro de post
    async function deleteReply(postId, replyId) {
      const post = db.posts.find(p => p.id === postId);
      if(!post) return;
      const idx = post.replies.findIndex(r => r.id === replyId);
      if(idx === -1) return;
      if(!canDeleteMessage(post.replies[idx].user, post.replies[idx].timestamp)) {
        alert('No puedes eliminar este comentario (solo si eres el autor y menos de 2 horas)');
        return;
      }
      if(!confirm('¿Seguro que quieres eliminar este comentario?')) return;
      post.replies.splice(idx, 1);
      await updateDB();
      showPosts();
    }

    // Mostrar posts y replies
    function showPosts() {
      const postsDiv = document.getElementById('posts');
      postsDiv.innerHTML = '';

      db.posts.slice().reverse().forEach(post => {
        const postDiv = document.createElement('div');
        postDiv.className = 'post';

        // Usuario
        const userBold = document.createElement('b');
        userBold.textContent = post.user;
        postDiv.appendChild(userBold);

        // Botón eliminar post (si puede)
        if(canDeleteMessage(post.user, post.timestamp)) {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Eliminar';
          delBtn.className = 'btn-delete';
          delBtn.onclick = () => deletePost(post.id);
          postDiv.appendChild(delBtn);
        }

        // Texto
        if(post.text) {
          const textP = document.createElement('p');
          textP.textContent = post.text;
          textP.style.marginTop = '6px';
          postDiv.appendChild(textP);
        }

        // Media
        if(post.media) {
          postDiv.appendChild(createMediaElement(post.media));
        }

        // Replies
        post.replies.forEach(rep => {
          const replyDiv = document.createElement('div');
          replyDiv.className = 'reply';

          const replyContent = document.createElement('div');
          replyContent.innerHTML = `<b>${rep.user}:</b> ${rep.text}`;
          replyDiv.appendChild(replyContent);

          // Botón eliminar reply si puede
          if(canDeleteMessage(rep.user, rep.timestamp)) {
            const delBtnR = document.createElement('button');
            delBtnR.textContent = 'Eliminar';
            delBtnR.className = 'btn-delete';
            delBtnR.style.top = '6px';
            delBtnR.style.right = '6px';
            delBtnR.onclick = () => deleteReply(post.id, rep.id);
            replyDiv.appendChild(delBtnR);
          }

          postDiv.appendChild(replyDiv);
        });

        // Reply input
        const replyInputDiv = document.createElement('div');
        replyInputDiv.className = 'reply-input';

        const inputReply = document.createElement('input');
        const inputId = 'replyInput_' + post.id;
        inputReply.id = inputId;
        inputReply.placeholder = 'Responder...';

        const btnReply = document.createElement('button');
        btnReply.textContent = 'Enviar';
        btnReply.onclick = () => addReply(post.id, inputId);

        replyInputDiv.appendChild(inputReply);
        replyInputDiv.appendChild(btnReply);

        postDiv.appendChild(replyInputDiv);

        postsDiv.appendChild(postDiv);
      });
    }

    // Al cargar la página:
    window.onload = async () => {
      await fetchDB();
      loadFromStorage();
    };

  </script>
</body>
</html>
